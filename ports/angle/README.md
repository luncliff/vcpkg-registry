# ANGLE Port - libANGLE Core + Null Backend Build

This port builds ANGLE (Almost Native Graphics Layer Engine) from GN source analysis, providing a standalone Chromium-free libANGLE core with the Null renderer backend.

## Current Status (2026-01-25)

- ‚úÖ Null-backend build now links `EGL.dll` and `GLESv2.dll` on x64-windows (debug) using the editable install command below. Output shows only MSVC C4273 dll-linkage warnings from autogenerated GLES entry points; no unresolved symbols remain.
- ‚úÖ Packages install to `packages/angle_x64-windows` with CMake config files emitted.
- ‚úÖ D3D9 + D3D11 backends now link on x64-windows (debug) with autogen staged into the binary tree; only MSVC C4273 dll-linkage warnings remain from GLES autogen (same as Null backend).

### Implementation Plan (Phase 1: Windows + Null Backend)

- [x] **Step 1**: Expand `angle_common` to full `libangle_common_sources` ‚úÖ
- [x] **Step 2**: Add `angle_image_util` helper library ‚úÖ
- [x] **Step 3**: Add `angle_gpu_info_util` (Windows GPU info only) ‚úÖ
- [x] **Step 4**: Add `translator` (GLSL/ESSL compiler library)
- [ ] **Step 5**: Add `angle_frame_capture_mock` (frame capture still disabled)
- [x] **Step 6**: Add `angle_libangle_core` (libANGLE without other backends)
- [x] **Step 7**: Add `angle_renderer_null` (Null renderer backend)
- [x] **Step 8**: Replace stub EGL/GLES with real entry points

### Latest Build Log (x64-windows debug)

- Command used (binary cache disabled):

```powershell
vcpkg install --overlay-ports=./ports `
  --x-buildtrees-root=buildtrees `
  --x-packages-root=packages `
  --x-install-root=installed `
  --editable angle
```

- Install log tail: [buildtrees/angle/install-x64-windows-dbg-out.log](buildtrees/angle/install-x64-windows-dbg-out.log)
- Result: `EGL.dll`, `GLESv2.dll`, `libANGLE.lib`, and helper libs all installed. Warnings: MSVC `C4273` inconsistent dll linkage from autogenerated GLES entry points (no link failures).

### What's Currently Building

- ‚úÖ `angle_common`, `angle_image_util`, `angle_gpu_info_util`
- ‚úÖ `angle_translator` (GLSL/ESSL/HLSL backends)
- ‚úÖ `libANGLE` core with Null backend
- ‚úÖ Real `EGL` / `GLESv2` entry point sources compile (autogen + stubs) and link into DLLs

### What Will Be Added

Phase 2 (D3D9 + D3D11 - In Progress):
- DirectX 9 backend (`d3d9/*`) for Windows desktop fallback
- DirectX 11 backend (`d3d11/*`) for modern Windows desktop
- DXGI format/support tables (autogenerated in binary tree)
- D3D11 autogen helpers (Blit11, texture format tables)
- Both backends linked with `/DELAYLOAD` for runtime flexibility

Phase 3+ (Future):
- Frame capture path re-enabled (currently compiled out)
- Additional backends (Vulkan/Metal/OpenGL)
- Upstream autogen regeneration hooks for all generated files

### Chromium Dependencies

- ‚úÖ `compression_utils_portable` replaced with a small system-zlib shim
- ‚ùå Frame capture implementation - disabled via `ANGLE_CAPTURE_ENABLED=0`
- üöß D3D9 + D3D11 backends - Windows desktop only (in progress, Phase 2)
- ‚ùå Vulkan/Metal/OpenGL backends - deferred to Phase 3+
- ‚ùå Abseil containers - optional, excluded initially

## Phase 2: D3D9 + D3D11 Backend Implementation Plan (2026-01-25)

### Objectives

Enable both DirectX 9 and DirectX 11 rendering backends for Windows desktop, mirroring GN's `d3d_backend.gni` source organization and configuration while generating all required autogen artifacts into `${PROJECT_BINARY_DIR}` instead of modifying the upstream source tree.

### Implementation Status

‚úÖ **CMakeLists.txt Updated**: All D3D9/D3D11 sources, autogen generation, defines, and link flags added  
‚úÖ **Autogen Inputs Staged**: `angle_format` helpers and DXGI/D3D11 JSON inputs copied to the binary tree before running generators  
‚úÖ **Build Passed (x64-windows dbg)**: `vcpkg install --editable angle` now links `EGL.dll` / `GLESv2.dll` with D3D9 + D3D11 enabled (warnings: MSVC C4273 dll-linkage only)

### Scope

- **Platform**: Windows desktop only (no UWP/WinRT support)
- **Backends**: D3D9 (fallback) + D3D11 (primary), both with delay-load for runtime flexibility
- **Autogen strategy**: Generate DXGI tables and D3D11 helpers during CMake configure into binary tree
- **Validation**: `vcpkg install --overlay-ports=./ports --x-buildtrees-root=buildtrees --x-packages-root=packages --x-install-root=installed --editable angle`

### Implementation Steps

#### 1. Add D3D9 Backend Sources (`LIBANGLE_D3D9_SOURCES`)

Mirror GN's `d3d9_backend_sources` from `src/libANGLE/renderer/d3d/d3d_backend.gni`:
- Core renderer: `Blit9`, `Buffer9`, `Context9`, `Device9`, `Fence9`, `Framebuffer9`, `Image9`, `Query9`, `Renderer9`, `SwapChain9`, `TextureStorage9`, `VertexBuffer9`, etc.
- Platform: `NativeWindow9`, `DebugAnnotator9`, `StateManager9`
- Compiled shaders: `d3d9/shaders/compiled/*.h` (passthrough, luminance, componentmask)
- Link flags: `/DELAYLOAD:d3d9.dll`, `d3d9.lib`, `delayimp.lib`

#### 2. Add DXGI Format/Support Tables (Autogenerated)

Run Python generators during CMake configure to create in `${PROJECT_BINARY_DIR}/src/libANGLE/renderer`:
- `gen_dxgi_format_table.py` ‚Üí `dxgi_format_map_autogen.cpp`
- `gen_dxgi_support_tables.py` ‚Üí `dxgi_support_table_autogen.cpp`

These provide `GetDXGIFormat()`, `GetDXGIFormatSize()`, and `GetDXGISupportInfo()` required by D3D11 backend.

#### 3. Enhance D3D11 Backend Autogen

Generate into `${PROJECT_BINARY_DIR}/src/libANGLE/renderer/d3d/d3d11`:
- `gen_blit11helper.py` ‚Üí `Blit11Helper_autogen.inc` (included by `Blit11.cpp`)
- `gen_texture_format_table.py` ‚Üí `texture_format_table_autogen.cpp`

Update `LIBANGLE_D3D11_SOURCES` and include directories to consume binary-tree outputs.

#### 4. Configure D3D Shared Settings

Add to `angle_libangle` (Windows only):
- Define: `ANGLE_PRELOADED_D3DCOMPILER_MODULE_NAMES={"d3dcompiler_47.dll", "d3dcompiler_46.dll", "d3dcompiler_43.dll"}`
- Define: `ANGLE_ENABLE_D3D9=1`, `ANGLE_ENABLE_D3D11=1`
- Remove: Any UWP-related defines (`ANGLE_ENABLE_WINDOWS_UWP`, `ANGLE_ENABLE_D3D11_COMPOSITOR_NATIVE_WINDOW`)

#### 5. Validate and Document Results

After CMake changes:
1. Run editable vcpkg install to capture build logs
2. Check for unresolved symbols (should be resolved)
3. Verify `EGL.dll` and `GLESv2.dll` link successfully with D3D9+D3D11
4. Update this README with build results and any warnings

### Expected Outcome

- ‚úÖ `angle_libangle` includes full D3D9 and D3D11 backend sources
- ‚úÖ All autogen artifacts generated cleanly in binary tree
- ‚úÖ `EGL.dll` / `GLESv2.dll` link without unresolved symbols
- ‚úÖ D3D11 selected as primary backend on Windows with D3D9 as fallback

### Known Limitations (Phase 2)

- No UWP/WinRT compositor support
- No D3D11 multiview or advanced compositor features
- Frame capture still disabled (`ANGLE_CAPTURE_ENABLED=0`)

## Phase 3: Vulkan Backend (Windows + Linux) - 2026-02-02

### Objectives

Enable ANGLE's Vulkan backend on Windows and Linux, leveraging the optional `vulkan` feature (enabled by default on these platforms). The Vulkan backend is feature-gated via vcpkg's manifest system and implemented with cross-platform CMake support.

### Implementation Status (2026-02-02)

‚úÖ **vcpkg feature defined**: `vulkan` feature added with platform filter `windows | linux`, default-enabled  
‚úÖ **Dependencies added**: `spirv-headers`, `vulkan-headers`, `vulkan-loader` (>= 1.4.328.0) declared in vcpkg.json  
‚úÖ **Portfile updated**: `vcpkg_check_features` maps `vulkan` feature ‚Üí `ANGLE_ENABLE_VULKAN` CMake option  
‚úÖ **CMake backend wired**: Vulkan sources extracted from `vulkan_backend.gni` and conditionally added for Windows/Linux  
üß™ **Build testing**: In progress‚Äîrunning editable vcpkg install on Windows to validate

### Scope

- **Platforms**: Windows (Win32 surface) + Linux (headless, simple, and DMA-buf offscreen surfaces)
- **Backend**: Vulkan renderer with platform-specific display/surface implementations
- **Feature control**: Optional via vcpkg feature; default ON for Windows/Linux, OFF otherwise
- **Autogen**: Uses upstream pre-generated files (`vk_format_table_autogen.cpp`, `vk_internal_shaders_autogen.cpp`, `vk_mandatory_format_support_table_autogen.cpp`)
- **Cross-platform**: Both Windows and Linux paths implemented with appropriate conditional compilation

### Implementation Steps

#### 1. vcpkg Feature and Dependencies

Added `vulkan` feature in [vcpkg.json](vcpkg.json):
- Default-enabled on `windows | linux` platforms
- Brings in `spirv-headers`, `vulkan-headers`, `vulkan-loader` (>= 1.4.328.0)

#### 2. Portfile Feature Mapping

Updated [portfile.cmake](portfile.cmake) to use `vcpkg_check_features`:
- Maps `vulkan` ‚Üí `ANGLE_ENABLE_VULKAN` CMake option
- Follows pattern from other ports (imgui, filament) for consistent feature handling

#### 3. CMake Backend Integration

Updated [CMakeLists.txt](CMakeLists.txt):
- Added `option(ANGLE_ENABLE_VULKAN)` with vcpkg-controlled default
- `find_package(Vulkan REQUIRED)` when feature enabled
- Extracted full Vulkan backend sources from `vulkan_backend.gni` (~110+ files):
  - Core backend: `BufferVk`, `ContextVk`, `RendererVk`, `CommandQueue`, etc.
  - Autogen files: `vk_format_table_autogen.cpp`, `vk_internal_shaders_autogen.cpp`, `vk_mandatory_format_support_table_autogen.cpp`
  - Platform-specific surfaces:
    - **Windows**: `win32/DisplayVkWin32`, `win32/WindowSurfaceVkWin32`
    - **Linux**: `linux/DisplayVkLinux`, `linux/DmaBufImageSiblingVkLinux`, `linux/display/DisplayVkSimple`, `linux/headless/DisplayVkHeadless`
- Conditional source inclusion: `LIBANGLE_VULKAN_SOURCES` + `LIBANGLE_VULKAN_WIN32_SOURCES` / `LIBANGLE_VULKAN_LINUX_SOURCES`
- Added `ANGLE_ENABLE_VULKAN=1` define when enabled (both Windows and Linux)
- Linked `Vulkan::Vulkan` target from vcpkg's vulkan-loader

#### 4. Validation (In Progress)

Running test install on Windows:
```powershell
vcpkg install --overlay-ports=ports --x-buildtrees-root=buildtrees --x-packages-root=packages --x-install-root=installed --editable angle
```

Expecting:
- Clean build with Vulkan backend alongside D3D9/D3D11 on Windows
- `EGL.dll` / `GLESv2.dll` link successfully with Vulkan symbols resolved
- No unresolved Vulkan dependencies or missing sources

### Known Limitations (Phase 3 - Initial)

- **Autogen regeneration**: Currently uses upstream pre-generated files; no CMake hooks for regenerating Vulkan format tables or internal shaders
- **OpenCL support**: OpenCL-on-Vulkan (`CL*Vk` classes) excluded from this phase
- **X11/Wayland/GBM**: Linux X11 (xcb), Wayland, and GBM display backends not yet wired (headless and simple only)
- **Android/Fuchsia/macOS**: Platform-specific Vulkan surfaces for these OSes not included (Windows + Linux only)
- **Vulkan validation layers**: Not explicitly enabled or configured; users must set up VK_LAYER_PATH manually if needed

### Next Steps

- ‚úÖ Complete Windows build testing
- Validate Linux build (via CI or local Linux environment)
- Update [GN_ANALYSIS.md](GN_ANALYSIS.md) with detailed Vulkan source mapping if build failures reveal gaps
- Consider enabling X11/Wayland backends for broader Linux display support
- Document Vulkan SDK assumptions (vcpkg-provided vs system SDK) in troubleshooting guide

## Analysis of ANGLE Build System

### GN Build Structure

ANGLE uses GN (Generate Ninja) build system with the following key files:

- `BUILD.gn` (49KB) - Main build configuration
- `src/libGLESv2.gni` (695 lines) - GLESv2 library sources
- `src/compiler.gni` (478 lines) - Shader compiler sources
- `src/libANGLE/renderer/*/BUILD.gn` - Backend-specific builds

### Source File Count

Based on GNI file analysis:

```
Common sources:          ~25 files
Compiler sources:        ~100+ files
libANGLE core:           ~150+ files
D3D11 backend:           ~80+ files
Vulkan backend:          ~200+ files
Metal backend:           ~100+ files
Total estimated:         650+ source files
```

### Build Complexity

1. **Platform-specific compilation**
   - Windows: D3D11 backend as primary
   - Linux: Vulkan/OpenGL backends
   - macOS: Metal/Vulkan backends
   - iOS: Metal backend

2. **Conditional compilation**
   - Backend selection via preprocessor defines
   - Feature flags for extensions
   - Platform-specific system calls

3. **Auto-generated files**
   - `*_autogen.cpp/h` files
   - Shader conversion tables
   - Extension headers
   - Entry point wrappers

## Comparison with Other Approaches

### This Port (Minimal CMake)
- ‚úÖ Simple to understand
- ‚úÖ Follows farmhash pattern
- ‚úÖ Provides stub `EGL` / `GLESv2` libraries and CMake targets for experimentation
- ‚ùå Incomplete (demo only; stubs, not full ANGLE)
- ‚ùå Requires manual source list maintenance

### PR #491 (Full CMake)
- ‚úÖ Complete implementation
- ‚úÖ All backends supported
- ‚ùå Too complex (full buildsystem rewrite)
- ‚ùå Difficult to maintain

### PR #532 (Native GN)
- ‚úÖ Uses upstream build system
- ‚ùå Blocked by Chromium dependencies
- ‚ùå Requires gclient infrastructure
- ‚ùå Not practical for vcpkg

### microsoft/vcpkg (Custom CMake)
- ‚úÖ Production-ready
- ‚úÖ Well-tested
- ‚úÖ Maintained
- ‚ÑπÔ∏è Complex but stable

## Recommendations

For users needing ANGLE:

1. **Use microsoft/vcpkg's angle port** (recommended)
   - Mature, tested, maintained
   - Full backend support
   - Production-ready

2. **Wait for upstream CMake support**
   - ANGLE team may add CMake in future
   - Would simplify vcpkg integration

3. **Contribute to this port**
   - Add remaining sources from GNI files
   - Implement backend selection
   - Test on multiple platforms

## Building

Build with vcpkg overlay and editable mode (disables binary caching for active development):

```powershell
vcpkg install --overlay-ports=./ports --editable angle
```

Or with explicit paths:

```powershell
vcpkg install --overlay-ports=./ports `
  --x-buildtrees-root=buildtrees `
  --x-packages-root=packages `
  --x-install-root=installed `
  --editable angle
```

**Current Build Output (partial)**:

- ‚úÖ `angle_common.lib`, `angle_image_util.lib`, `angle_gpu_info_util.lib`, `angle_translator.lib`, `libANGLE.lib`
- ‚ùå Link failure at `EGL.dll` on x64-windows (debug)
- ‚ö†Ô∏è `GLESv2.dll` status is not meaningful until `EGL.dll` links cleanly (the build stops at the first failing target)

### Debugging Notes

This port intentionally avoids GN and Chromium build plumbing. That means we must manually ensure that the CMake targets include:

- The correct libEGL/libGLESv2 source sets (including any non-obvious helper .cpp files that define exported symbols)
- The correct `*_IMPLEMENTATION` defines for each DLL (`LIBEGL_IMPLEMENTATION`, `LIBGLESV2_IMPLEMENTATION`)
- The correct autogen stubs/export tables that provide `GL_*` symbols referenced by the autogenerated getprocaddress layer

At the moment, the CMake target graph is close (it compiles), but the Windows DLL export plumbing is incomplete.

## Future Phases

### Phase 2: Additional Backends
- Direct3D 11 backend for Windows (D3D9 deferred)
- Vulkan backend (multi-platform)
- Metal backend (macOS/iOS)
- OpenGL backend (fallback)

### Phase 3: Advanced Features
- Frame capture re-enabled (with non-Chromium compression)
- Abseil integration for performance-critical containers
- Full test suite integration

## Work Log (2026-01-25)

- Built x64-windows debug with the editable install command above; `EGL.dll` and `GLESv2.dll` now link and install. Only MSVC `C4273` warnings remain from autogenerated GLES entry points.
- Next target: enable D3D11 backend (keep D3D9 for later).
- Wired D3D11 shared/backend sources into CMake (Windows-gated), globbed the generated blit shader headers, and linked d3d11/dxgi/d3dcompiler/dxguid; ready to rebuild and capture any missing GN-generated assets or symbols.

## Plan: Bring Up D3D11 Backend

- Scope: D3D11 only; D3D9 will be deferred.
- Source intake: pull `libANGLE/renderer/d3d` shared sources plus the D3D11 set listed in `src/libANGLE/renderer/d3d/d3d_backend.gni` into `angle_libangle` when `ANGLE_IS_WIN`.
- Defines/options: keep `ANGLE_ENABLE_NULL` until D3D11 is wired; add backend toggles for D3D11 and ensure `LIBANGLE_IMPLEMENTATION` is applied to D3D sources.
- Linking: add `d3d11.lib` and `dxgi.lib` (already present for gpu_info_util) alongside existing Win32 libs.
- Autogen/generators: if D3D11 shader headers or format tables are missing, wire the GN/Python generators (e.g., `gen_dxgi_format_table.py`, precompiled shader headers) and note any failures with command lines and missing inputs.
- Validation: rebuild with the same editable command, capture linker gaps, and update this README with any missing symbols and the GN source that provides them.

## References

- [ANGLE Repository](https://github.com/google/angle)
- [PR #532 - GN Build Analysis](https://github.com/luncliff/vcpkg-registry/pull/532)
- [PR #491 - Full CMake Port](https://github.com/luncliff/vcpkg-registry/pull/491)
- [microsoft/vcpkg ANGLE Port](https://github.com/microsoft/vcpkg/tree/master/ports/angle)
