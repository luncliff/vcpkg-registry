# ANGLE Port - libANGLE Core + Null Backend Build

This port builds ANGLE (Almost Native Graphics Layer Engine) from GN source analysis, providing a standalone Chromium-free libANGLE core with the Null renderer backend.

## Current Status: üöß Work In Progress - libANGLE Core + Null Backend wired to real EGL/GLES entry points

This port currently **compiles most of ANGLE's core libraries**, but **fails at link-time on Windows** when producing `EGL.dll`.

The immediate goal for Phase 1 is to reliably produce **Windows DLLs** (`EGL.dll` + `GLESv2.dll`) that expose real entry points and route into the libANGLE core with the Null backend.

### Implementation Plan (Phase 1: Windows + Null Backend)

- [x] **Step 1**: Expand `angle_common` to full `libangle_common_sources` ‚úÖ
- [x] **Step 2**: Add `angle_image_util` helper library ‚úÖ
- [x] **Step 3**: Add `angle_gpu_info_util` (Windows GPU info only) ‚úÖ
- [x] **Step 4**: Add `translator` (GLSL/ESSL compiler library)
- [ ] **Step 5**: Add `angle_frame_capture_mock` (frame capture still disabled)
- [x] **Step 6**: Add `angle_libangle_core` (libANGLE without other backends)
- [x] **Step 7**: Add `angle_renderer_null` (Null renderer backend)
- [x] **Step 8**: Replace stub EGL/GLES with real entry points

### Current Failure (x64-windows)

The build currently fails while linking `EGL.dll` (debug build) during `vcpkg install`.

Repro command:

```powershell
vcpkg install --overlay-ports=./ports `
   --x-buildtrees-root=buildtrees `
   --x-packages-root=packages `
   --x-install-root=installed `
   --editable angle
```

Primary log of interest:

- `buildtrees/angle/install-x64-windows-dbg-out.log`

Observed linker errors (representative):

- `egl::SetEGLValidationEnabled(bool)` referenced by `egl::SetValidationEnabledANGLE`
- `angle::GetANGLEVersionString()` referenced by `egl::QueryString` and `libANGLE::Context`
- `egl::ScopedSyncCurrentContextFromThread::{ctor,dtor}` referenced by `egl::DestroyContext`
- Multiple missing `GL_*` extension export symbols referenced by `egl_stubs_getprocaddress_autogen.cpp`:
   - `GL_EGLImageTargetTexStorageEXT`
   - `GL_DrawArraysInstancedBaseInstanceEXT`
   - `GL_DrawElementsInstancedBaseInstanceEXT`
   - `GL_DrawElementsInstancedBaseVertexBaseInstanceEXT`
   - `GL_BindFragDataLocationEXT`, `GL_BindFragDataLocationIndexedEXT`
   - `GL_GetFragDataIndexEXT`, `GL_GetProgramResourceLocationIndexEXT`
   - `GL_BufferStorageEXT`, `GL_ClearTexImageEXT`, `GL_ClearTexSubImageEXT`
   - `GL_ClipControlEXT`, `GL_CopyImageSubDataEXT`
   - `GL_GetObjectLabelEXT`, `GL_LabelObjectEXT`

These failures strongly indicate the `angle_egl` target is still missing one or more source files (or a small helper library) that provides:

1. The EGL validation/version helpers (`SetEGLValidationEnabled`, `GetANGLEVersionString`)
2. The EGL thread/context sync RAII helper (`ScopedSyncCurrentContextFromThread`)
3. The exported GL extension entry point function pointers used by the autogenerated getprocaddress stubs

### What's Currently Building

- ‚úÖ `angle_common`, `angle_image_util`, `angle_gpu_info_util`
- ‚úÖ `angle_translator` (GLSL/ESSL/HLSL backends)
- ‚úÖ `libANGLE` core with Null backend
- ‚úÖ Real `EGL` / `GLESv2` entry point sources compile (autogen + stubs)
- ‚ùå `EGL.dll` does not link yet (unresolved externals listed above)

### What Will Be Added

1. Frame capture path re-enabled (currently compiled out)
2. Optional backends (D3D11/Vulkan/Metal/OpenGL)
3. Upstream autogen regeneration hooks instead of relying on pre-generated files

### Chromium Dependencies

- ‚úÖ `compression_utils_portable` replaced with a small system-zlib shim
- ‚ùå Frame capture implementation - disabled via `ANGLE_CAPTURE_ENABLED=0`
- ‚ùå Vulkan/D3D11/Metal backends - deferred to Phase 2+
- ‚ùå Abseil containers - optional, excluded initially

## Analysis of ANGLE Build System

### GN Build Structure

ANGLE uses GN (Generate Ninja) build system with the following key files:

- `BUILD.gn` (49KB) - Main build configuration
- `src/libGLESv2.gni` (695 lines) - GLESv2 library sources
- `src/compiler.gni` (478 lines) - Shader compiler sources
- `src/libANGLE/renderer/*/BUILD.gn` - Backend-specific builds

### Source File Count

Based on GNI file analysis:

```
Common sources:          ~25 files
Compiler sources:        ~100+ files
libANGLE core:           ~150+ files
D3D11 backend:           ~80+ files
Vulkan backend:          ~200+ files
Metal backend:           ~100+ files
Total estimated:         650+ source files
```

### Build Complexity

1. **Platform-specific compilation**
   - Windows: D3D11 backend as primary
   - Linux: Vulkan/OpenGL backends
   - macOS: Metal/Vulkan backends
   - iOS: Metal backend

2. **Conditional compilation**
   - Backend selection via preprocessor defines
   - Feature flags for extensions
   - Platform-specific system calls

3. **Auto-generated files**
   - `*_autogen.cpp/h` files
   - Shader conversion tables
   - Extension headers
   - Entry point wrappers

## Comparison with Other Approaches

### This Port (Minimal CMake)
- ‚úÖ Simple to understand
- ‚úÖ Follows farmhash pattern
- ‚úÖ Provides stub `EGL` / `GLESv2` libraries and CMake targets for experimentation
- ‚ùå Incomplete (demo only; stubs, not full ANGLE)
- ‚ùå Requires manual source list maintenance

### PR #491 (Full CMake)
- ‚úÖ Complete implementation
- ‚úÖ All backends supported
- ‚ùå Too complex (full buildsystem rewrite)
- ‚ùå Difficult to maintain

### PR #532 (Native GN)
- ‚úÖ Uses upstream build system
- ‚ùå Blocked by Chromium dependencies
- ‚ùå Requires gclient infrastructure
- ‚ùå Not practical for vcpkg

### microsoft/vcpkg (Custom CMake)
- ‚úÖ Production-ready
- ‚úÖ Well-tested
- ‚úÖ Maintained
- ‚ÑπÔ∏è Complex but stable

## Recommendations

For users needing ANGLE:

1. **Use microsoft/vcpkg's angle port** (recommended)
   - Mature, tested, maintained
   - Full backend support
   - Production-ready

2. **Wait for upstream CMake support**
   - ANGLE team may add CMake in future
   - Would simplify vcpkg integration

3. **Contribute to this port**
   - Add remaining sources from GNI files
   - Implement backend selection
   - Test on multiple platforms

## Building

Build with vcpkg overlay and editable mode (disables binary caching for active development):

```powershell
vcpkg install --overlay-ports=./ports --editable angle
```

Or with explicit paths:

```powershell
vcpkg install --overlay-ports=./ports `
  --x-buildtrees-root=buildtrees `
  --x-packages-root=packages `
  --x-install-root=installed `
  --editable angle
```

**Current Build Output (partial)**:

- ‚úÖ `angle_common.lib`, `angle_image_util.lib`, `angle_gpu_info_util.lib`, `angle_translator.lib`, `libANGLE.lib`
- ‚ùå Link failure at `EGL.dll` on x64-windows (debug)
- ‚ö†Ô∏è `GLESv2.dll` status is not meaningful until `EGL.dll` links cleanly (the build stops at the first failing target)

### Debugging Notes

This port intentionally avoids GN and Chromium build plumbing. That means we must manually ensure that the CMake targets include:

- The correct libEGL/libGLESv2 source sets (including any non-obvious helper .cpp files that define exported symbols)
- The correct `*_IMPLEMENTATION` defines for each DLL (`LIBEGL_IMPLEMENTATION`, `LIBGLESV2_IMPLEMENTATION`)
- The correct autogen stubs/export tables that provide `GL_*` symbols referenced by the autogenerated getprocaddress layer

At the moment, the CMake target graph is close (it compiles), but the Windows DLL export plumbing is incomplete.

## Future Phases

### Phase 2: Additional Backends
- Direct3D 11 backend for Windows
- Vulkan backend (multi-platform)
- Metal backend (macOS/iOS)
- OpenGL backend (fallback)

### Phase 3: Advanced Features
- Frame capture re-enabled (with non-Chromium compression)
- Abseil integration for performance-critical containers
- Full test suite integration

## References

- [ANGLE Repository](https://github.com/google/angle)
- [PR #532 - GN Build Analysis](https://github.com/luncliff/vcpkg-registry/pull/532)
- [PR #491 - Full CMake Port](https://github.com/luncliff/vcpkg-registry/pull/491)
- [microsoft/vcpkg ANGLE Port](https://github.com/microsoft/vcpkg/tree/master/ports/angle)
