# https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  win: circleci/windows@5.0
  aws-cli: circleci/aws-cli@4.1.2 # https://circleci.com/developer/orbs/orb/circleci/aws-cli
  aws-s3: circleci/aws-s3@4.0

workflows:
  overlay:
    jobs:
      - x64_windows:
          filters:
            branches:
              ignore:
                - gh-pages
                - docs
      - x64_linux_gcc:
          filters:
            branches:
              ignore:
                - gh-pages
                - docs

jobs:
  x64_windows:
    executor:
      name: win/server-2022
      size: large
      shell: "bash.exe"
    environment:
      VCPKG_DOWNLOADS: C:/vcpkg-caches
      VCPKG_DEFAULT_BINARY_CACHE: C:/vcpkg-caches
      VCPKG_DEFAULT_TRIPLET: x64-windows
    steps:
      - checkout
      - aws-cli/setup
      - run:
          name: "Setup: microsoft/vcpkg(2023.12.12)"
          shell: "powershell.exe"
          command: |
            New-Item -Type Directory -Force -Path $env:VCPKG_DOWNLOADS
            New-Item -Type Directory -Force -Path $env:VCPKG_DEFAULT_BINARY_CACHE
            git clone --branch=2023.12.12 --depth=1 https://github.com/microsoft/vcpkg
            Push-Location vcpkg
              ./bootstrap-vcpkg.bat
              ./vcpkg.exe --version
            Pop-Location
      - restore_cache:
          keys:
            - v2406-caches-{{ .Branch }}
            - v2406-caches-{{ checksum ".circleci/config.yml" }}
            - v2406-caches-main
            - v2404-caches-main
      - run:
          name: "Install: port-windows.txt"
          shell: "powershell.exe"
          command: |
            ./vcpkg.exe install `
              --recurse `
              --clean-buildtrees-after-build `
              --clean-packages-after-build `
              --overlay-ports="$env:CIRCLE_WORKING_DIRECTORY/ports" `
              $(Get-Content "$env:CIRCLE_WORKING_DIRECTORY/.circleci/port-setup.txt") `
              $(Get-Content "$env:CIRCLE_WORKING_DIRECTORY/.circleci/port-windows.txt")
          working_directory: vcpkg
          no_output_timeout: 1h
      - when:
          condition:
            equal: [ main, << pipeline.git.branch >> ]
          steps:
           - save_cache:
              key: v2406-caches-main
              paths:
                - C:/vcpkg-caches
      - save_cache:
          key: v2406-caches-{{ .Branch }}
          paths:
            - C:/vcpkg-caches
      - save_cache:
          key: v2406-caches-{{ checksum ".circleci/config.yml" }}
          paths:
            - C:/vcpkg-caches
      - store_artifacts:
          path: vcpkg/buildtrees/
          destination: "build-logs"

  x64_linux_gcc:
    docker:
      - image: gcc:13.2
    resource_class: large
    environment:
      VCPKG_DEFAULT_TRIPLET: x64-linux
    steps:
      - checkout
      - aws-cli/setup
      - run:
          name: "Setup: microsoft/vcpkg(2024.02.14)"
          command: |
            git clone --branch=2024.02.14 --depth=1 https://github.com/microsoft/vcpkg
            pushd vcpkg
              ./bootstrap-vcpkg.sh
              ./vcpkg --version
            popd
      - run:
          name: "Install: port-setup.txt"
          command: |
            ./vcpkg install \
              --recurse \
              --clean-buildtrees-after-build \
              --clean-packages-after-build \
              --overlay-ports="$CIRCLE_WORKING_DIRECTORY/ports" \
              $(cat "$CIRCLE_WORKING_DIRECTORY/.circleci/port-setup.txt")
          working_directory: vcpkg
      - store_artifacts:
          path: vcpkg/buildtrees/
          destination: "build-logs"
