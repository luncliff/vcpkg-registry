#
# https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema
# https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables
# https://github.com/actions/virtual-environments/tree/main/images
# https://github.com/lukka/CppBuildTasks
#

# trigger:
#   - main

pr:
  - main

schedules:
  - cron: "10 4 * * 6"
    displayName: "Weekly check"
    branches:
      include:
        - main

variables:
  - name: VCPKG_DISABLE_METRICS
    value: "true"
  - name: vcpkg_version
    value: "2021.05.12"
  - name: overaly_arguments
    value: "--overlay-ports $(Build.SourcesDirectory)/ports --overlay-triplets $(Build.SourcesDirectory)/triplets"

jobs:
  - job: "windows_2019"
    pool:
      vmImage: windows-2019
    variables:
      - name: windows_port_list
        value: "lua[cpp] zlib-ng"
    steps:
      - powershell: systeminfo
      - task: run-vcpkg@0
        inputs:
          vcpkgGitCommitId: $(vcpkg_version)
          vcpkgArguments: "--triplet x64-windows $(overaly_arguments) $(windows_port_list)"
        displayName: "x64-windows"
      - task: run-vcpkg@0
        inputs:
          vcpkgGitCommitId: $(vcpkg_version)
          vcpkgArguments: "--triplet x86-windows $(overaly_arguments) $(windows_port_list)"
        displayName: "x86-windows"

  - job: "windows_2022"
    pool:
      vmImage: windows-2022
    variables:
      - name: windows_port_list
        value: "lua[cpp] zlib-ng"
    steps:
      - powershell: systeminfo
      - task: run-vcpkg@0
        inputs:
          vcpkgGitCommitId: $(vcpkg_version)
          vcpkgArguments: "--triplet x64-windows $(overaly_arguments) $(windows_port_list)"
        displayName: "x64-windows"

  - job: "android_on_windows_2019"
    pool:
      vmImage: windows-2019
    variables:
      - name: android_port_list
        value: "lua[cpp] zlib-ng"
    steps:
      - powershell: systeminfo
      - task: run-vcpkg@0
        inputs:
          vcpkgGitCommitId: $(vcpkg_version)
          vcpkgArguments: "--triplet arm64-android $(overaly_arguments) $(android_port_list)"
        env:
          ANDROID_NDK_HOME: $(ANDROID_NDK_LATEST_HOME)
        displayName: "arm64-android"
      - task: run-vcpkg@0
        inputs:
          vcpkgGitCommitId: $(vcpkg_version)
          vcpkgArguments: "--triplet arm-android   $(overaly_arguments) $(android_port_list)"
        env:
          ANDROID_NDK_HOME: $(ANDROID_NDK_LATEST_HOME)
        displayName: "arm-android"
      - task: run-vcpkg@0
        inputs:
          vcpkgGitCommitId: $(vcpkg_version)
          vcpkgArguments: "--triplet x64-android   $(overaly_arguments) $(android_port_list)"
        env:
          ANDROID_NDK_HOME: $(ANDROID_NDK_LATEST_HOME)
        displayName: "x64-android"

  - job: "macos_15"
    pool:
      vmImage: macOS-10.15
    variables:
      - name: osx_port_list
        value: "lua[cpp] zlib-ng"
    steps:
      - template: azure/run-vcpkg-with-overlay.yml
        parameters:
          vcpkg_triplet: "x64-osx"
          port_list: "zlib-ng"
      - template: azure/run-vcpkg-with-overlay.yml
        parameters:
          vcpkg_triplet: "arm64-osx"
          port_list: "zlib-ng"
