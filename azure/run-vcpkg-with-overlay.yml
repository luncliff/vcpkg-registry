#
# Author: github.com/luncliff (luncliff@gmail.com)
#
# References
#   https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops#step-reuse
#   https://github.com/microsoft/vcpkg/releases/tag/2021.05.12
#   https://github.com/microsoft/vcpkg/blob/2021.05.12/docs/users/config-environment.md
#

parameters:
  - name: port_name
    type: string
  - name: target_triplet
    type: string

steps:
  - task: run-vcpkg@0
    displayName: "${{ parameters.target_triplet }}: ${{ parameters.port_name }}"
    inputs:
      vcpkgGitCommitId: "2021.05.12"
      vcpkgArguments: "${{ parameters.port_name }}" # vcpkg install ${port_name} ...
    env:
      VCPKG_DEFAULT_TRIPLET: ${{ parameters.target_triplet }} # --triplet ${target_triplet}
      VCPKG_OVERLAY_PORTS: $(Build.SourcesDirectory)/ports # --overlay-ports $(Build.SourcesDirectory)/ports
      # VCPKG_OVERLAY_TRIPLETS: $(Build.SourcesDirectory)/triplets # --overlay-triplets $(Build.SourcesDirectory)/triplets
      ANDROID_NDK_HOME: $(ANDROID_NDK_LATEST_HOME)
    continueOnError: true
  - task: CopyFiles@2
    inputs:
      SourceFolder: "$(Build.BinariesDirectory)/vcpkg/buildtrees/${{ parameters.port_name }}" # check how https://github.com/lukka/CppBuildTasks works
      Contents: |
        ?(*.log|*.txt)
        *.cmake
      TargetFolder: "$(Build.ArtifactStagingDirectory)"
      OverWrite: true
    condition: failed()
  # - task: DeleteFiles@1
  #   inputs:
  #     SourceFolder: "$(Build.BinariesDirectory)/vcpkg/downloads"
  #     Contents: "**/*" # todo: change to downloads, buildtrees, etc.
  #     RemoveSourceFolder: true
  #     RemoveDotFiles: true
